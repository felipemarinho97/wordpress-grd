!function(a,b){"use strict";a.previewPosts||(a.previewPosts={}),a.previewPosts.data||(a.previewPosts.data={}),a.previewPosts.wpApiModelInstances=_.extend({},a.Events),b(document.body).on("mousedown",function(a){a.shiftKey&&a.preventDefault()}),a.previewPosts.parsePostClassName=function(a){var b,c,d;return(b=a.match(/(\s|^)post-(\d+)(\s|$)/))?(c=parseInt(b[2],10),(b=a.match(/(\s|^)type-(\S+)(\s|$)/))?(d=b[2],{postId:c,postType:d}):null):null},"undefined"!=typeof MutationObserver&&(a.previewPosts.mutationObserver=new MutationObserver(function(c){_.each(c,function(c){var d,e;e=b(c.target),d=e.find(".hentry"),e.is(".hentry")&&(d=d.add(e)),d.each(function(){var d,f;d=a.previewPosts.parsePostClassName(b(this).prop("className")),d&&(f="post["+d.postType+"]["+String(d.postId)+"]",a.previewPosts.ensurePartialsForPostSetting(f),_.each(a.previewPosts.partialSchema(f),function(d){var f;f=a.selectiveRefresh.partial(d.id),f&&_.each(f.placements(),function(d){(e.is(d.container)||b.contains(c.target,d.container[0]))&&(b(d.container).attr("title",a.selectiveRefresh.data.l10n.shiftClickToEdit),f.createEditShortcutForPlacement(d))})}))})})}),a.previewPosts.mutationObserver.observe(document.documentElement,{childList:!0,subtree:!0})),a.previewPosts.ensurePartialsForPostSetting=function(c){var d=[],e=/^post\[(.+?)]\[(-?\d+)]\[(.+?)](?:\[(.+?)])?$/;return/^post\[(.+?)]\[(\d+)]$/.test(c.id)?(_.each(a.previewPosts.partialSchema(c.id),function(c){var f,g,h,i,j;if(g=c.id.match(e),!g)throw new Error("Bad PostFieldPartial id. Expected post[:post_type][:post_id][:field_id]");a.selectiveRefresh.partial.has(c.id)||(i=g[1],h=parseInt(g[2],10),c.params.selector?(j=[".hentry.post-"+String(h)],"page"===i?j.push("body.page.page-id-"+String(h)):j.push("body.postid-"+String(h)),c.params.selector=_.map(j,function(a){var b=a+" "+c.params.selector;return b=b.replace(/%d/g,String(h))}).join(", "),f=new a.selectiveRefresh.partialConstructor.post_field(c.id,{params:c.params}),a.selectiveRefresh.partial.add(f.id,f),d.push(f)):(f=new a.selectiveRefresh.partialConstructor.post_field(c.id,{params:c.params}),f.refresh=function(){var c=b.Deferred();return this.params.fallbackRefresh?(a.selectiveRefresh.requestFullRefresh(),c.resolve()):c.reject(),c.promise()},a.selectiveRefresh.partial.add(f.id,f),d.push(f)))}),d):[]},a.previewPosts.partialSchema=function(b){var c=[];return _.each(a.previewPosts.data.partialSchema,function(d,e){var f,g;g=e.replace(/]/g,"").split(/\[/),f=b+"["+g.join("][")+"]",d.settings=[b],c.push({id:f,params:a.previewPosts.snakeToCamel(d)})}),c},a.previewPosts.snakeToCamel=function(a){var b={};return _.each(a,function(a,c){var d=c.replace(/_\w/g,function(a){return a[1].toUpperCase()});b[d]=a}),b},a.isLinkPreviewable&&(a.isLinkPreviewable=function(a){return function(c,d){return!!b(c).closest("a").hasClass("post-edit-link")||a.call(this,c,d)}}(a.isLinkPreviewable)),a.Preview.prototype.handleLinkClick&&(a.Preview.prototype.handleLinkClick=function(a){return function(c){b(c.target).closest("a").hasClass("post-edit-link")?c.preventDefault():a.call(this,c)}}(a.Preview.prototype.handleLinkClick)),a.previewPosts.injectBackboneModelSync=function(){var b=wp.api.WPApiBaseModel.prototype.initialize,c=!1;wp.customize.bind("active",function(){c=!0}),wp.api.WPApiBaseModel.prototype.initialize=function(d,e){var f,g=this;b.call(g,d,e),d&&-1!==a.previewPosts.data.postTypes.indexOf(d.type)&&(f="post["+d.type+"]["+String(d.id)+"]",a.previewPosts.wpApiModelInstances[f]||(a.previewPosts.wpApiModelInstances[f]=[]),a.previewPosts.wpApiModelInstances[f].push(g),a.previewPosts.wpApiModelInstances.trigger("add",g,f),a(f,function(b){var d=function(b){a.previewPosts.handlePostSettingChangeForBackboneModel(g,b)};c&&d(b.get()),b.bind(d)}))},a.selectiveRefresh.bind("render-partials-response",a.previewPosts.handleRenderPartialsResponse)},a.previewPosts.handlePostSettingChangeForBackboneModel=function(a,b){var c={};_.each(["title","content","excerpt"],function(d){_.isObject(a.get(d))&&(a.get(d).raw&&a.get(d).raw===b["post_"+d]||(c[d]={raw:b["post_"+d],rendered:b["post_"+d]},!c[d].rendered||"excerpt"!==d&&"content"!==d||(c[d].rendered="<p>"+c[d].rendered.split(/\n\n+/).join("</p><p>")+"</p>",c[d].rendered=c[d].rendered.replace(/\n/g,"<br>"))))}),_.each(["author","slug"],function(d){_.isUndefined(a.get(d))||(c[d]=b["post_"+d])}),_.isUndefined(a.get("date"))||(c.date=b.post_date.replace(" ","T")),a.set(c)},a.previewPosts.handleRenderPartialsResponse=function(b){b.rest_post_resources&&_.each(b.rest_post_resources,function(b,c){a.previewPosts.wpApiModelInstances[c]&&_.each(a.previewPosts.wpApiModelInstances[c],function(a){a.set(b)})})},a.bind("preview-ready",function(){_.extend(a.previewPosts.data,_wpCustomizePreviewPostsData),a.previewPosts.data.hasRestApiBackboneClient&&a.previewPosts.injectBackboneModelSync(),a.each(a.previewPosts.ensurePartialsForPostSetting),a.bind("add",a.previewPosts.ensurePartialsForPostSetting),a.preview.bind("customize-posts-setting",function(b){a.has(b.id)||a.create(b.id,b.value,{id:b.id})}),a.preview.bind("active",function(){a.preview.send("customized-posts",{isPostPreview:a.previewPosts.data.isPostPreview,isSingular:a.previewPosts.data.isSingular,queriedPostId:a.previewPosts.data.queriedPostId,postIds:a.previewPosts.data.postIds}),b(document.body).on("click",".post-edit-link",function(c){var d,e,f=b(this);e=f.prop("search").match(/post=(\d+)/),e&&(d=parseInt(e[1],10),c.preventDefault(),d&&a.preview.send("edit-post",d))})}),a.selectiveRefresh.bind("render-partials-response",function(b){b.queried_post_ids&&a.preview.send("customized-posts",{postIds:b.queried_post_ids,isPartial:!0})}),b(document).ajaxSuccess(function(b,c,d,e){var f,g="POST"===d.type&&-1!==d.url.indexOf("infinity=scrolling");g&&(f="string"==typeof e?JSON.parse(e):e,f.queried_post_ids&&a.preview.send("customized-posts",{postIds:f.queried_post_ids,isPartial:!0}))})})}(wp.customize,jQuery);